<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Kana Quiz</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0d0f14" />

  <!-- iOS meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Kana Quiz" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@400;700&display=swap"
    rel="stylesheet" />
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0d0f14;
      --surface: #161a23;
      --surface2: #1e2330;
      --border: #2c3347;
      --accent: #7c6fff;
      --accent2: #a78bfa;
      --green: #34d399;
      --red: #f87171;
      --text: #e8eaf0;
      --muted: #8892a4;
      --radius: 14px;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    /* lock-scroll removed to fix mobile keyboard issues */

    #app {
      min-height: 100svh;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      position: relative;
    }

    /* centered removed to keep content at top, avoiding keyboard overlap */

    .screen {
      display: none;
      width: 100%;
      max-width: 480px;
    }

    .screen.active {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      text-align: center;
      padding: 12px 0 6px;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -.5px;
    }

    header p {
      font-size: .8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
    }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 22px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: opacity .15s, transform .1s;
      user-select: none;
      -webkit-user-select: none;
    }

    .btn:active {
      transform: scale(.97);
    }

    .btn:disabled {
      opacity: .35;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      width: 100%;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: .85rem;
      padding: 8px 14px;
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      font-size: .8rem;
      padding: 6px 10px;
    }

    /* ‚îÄ‚îÄ Mode Toggle ‚îÄ‚îÄ */
    .mode-toggle {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      background: var(--surface2);
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .mode-toggle button {
      padding: 8px 4px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mode-toggle button.active {
      background: var(--surface);
      color: var(--text);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
    }

    /* ‚îÄ‚îÄ Selection screen ‚îÄ‚îÄ */
    .sel-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .group-block {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .group-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--surface2);
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .group-header label {
      font-weight: 600;
      font-size: .9rem;
      cursor: pointer;
      flex: 1;
    }

    .group-header span {
      font-size: .75rem;
      color: var(--muted);
    }

    .group-entries {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1px;
      background: var(--border);
    }

    .kana-entry {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 12px;
      background: var(--surface);
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      transition: background .12s;
    }

    .kana-entry:hover {
      background: var(--surface2);
    }

    .kana-chars {
      display: flex;
      flex-direction: column;
      line-height: 1.3;
    }

    .kana-chars .hira {
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 1.05rem;
    }

    .kana-chars .kata {
      font-family: 'Noto Sans JP', sans-serif;
      font-size: .85rem;
      color: var(--muted);
    }

    .kana-roma {
      font-size: .78rem;
      color: var(--accent2);
      margin-left: auto;
    }

    /* custom checkbox */
    .kana-entry input[type=checkbox],
    .group-header input[type=checkbox] {
      appearance: none;
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-radius: 5px;
      flex-shrink: 0;
      cursor: pointer;
      transition: background .15s, border-color .15s;
      position: relative;
    }

    .kana-entry input[type=checkbox]:checked,
    .group-header input[type=checkbox]:checked {
      background: var(--accent);
      border-color: var(--accent);
    }

    .kana-entry input[type=checkbox]:checked::after,
    .group-header input[type=checkbox]:checked::after {
      content: '';
      position: absolute;
      left: 3px;
      top: 0px;
      width: 6px;
      height: 10px;
      border: 2px solid #fff;
      border-top: none;
      border-left: none;
      transform: rotate(45deg);
    }

    .group-header input[type=checkbox]:indeterminate {
      background: var(--surface2);
      border-color: var(--accent);
    }

    .group-header input[type=checkbox]:indeterminate::after {
      content: '';
      position: absolute;
      left: 3px;
      top: 6px;
      width: 8px;
      height: 2px;
      background: var(--accent);
    }

    .sel-count {
      font-size: .85rem;
      color: var(--muted);
      text-align: center;
    }

    .sel-count strong {
      color: var(--text);
    }

    /* ‚îÄ‚îÄ Quiz screen ‚îÄ‚îÄ */
    .quiz-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .82rem;
      color: var(--muted);
    }

    .quiz-score {
      font-weight: 600;
      color: var(--text);
    }

    .kana-display {
      text-align: center;
      padding: 16px;
      position: relative;
      overflow: hidden;
    }

    .script-badge {
      display: inline-block;
      font-size: .72rem;
      font-weight: 600;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--accent2);
      background: rgba(124, 111, 255, .15);
      padding: 4px 10px;
      border-radius: 20px;
      margin-bottom: 14px;
    }

    .kana-char {
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 5rem;
      line-height: 1;
      display: block;
      transition: opacity .15s, transform .15s;
    }

    .input-row {
      display: flex;
      gap: 10px;
    }

    #romaji-input {
      flex: 1;
      background: var(--surface2);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1.1rem;
      padding: 14px 16px;
      outline: none;
      transition: border-color .2s;
      font-family: 'Inter', sans-serif;
      -webkit-appearance: none;
      appearance: none;
    }

    #romaji-input:focus {
      border-color: var(--accent);
    }

    #romaji-input.correct {
      border-color: var(--green);
    }

    #romaji-input.wrong {
      border-color: var(--red);
    }

    #submit-btn {
      flex-shrink: 0;
      width: auto;
      padding: 14px 22px;
    }

    .easy-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      width: 100%;
    }

    .easy-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 0;
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: transform 0.1s, background 0.1s;
      user-select: none;
      -webkit-user-select: none;
    }

    .easy-btn.simple-btn {
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 1.6rem;
    }

    .easy-btn:active {
      transform: scale(0.92);
    }

    /* ‚îÄ‚îÄ Drawing Area ‚îÄ‚îÄ */
    .draw-area {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    #draw-canvas {
      background: var(--surface2);
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: crosshair;
      touch-action: none;
    }

    .draw-controls {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 280px;
      margin: 0 auto;
    }

    .draw-controls .btn {
      flex: 1;
    }

    .self-grade {
      display: none;
      width: 100%;
      max-width: 280px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
    }

    .self-grade .btn {
      flex: 1;
    }

    .btn-correct {
      background: rgba(52, 211, 153, .15);
      color: var(--green);
      border: 1px solid var(--green);
    }

    .btn-wrong {
      background: rgba(248, 113, 113, .15);
      color: var(--red);
      border: 1px solid var(--red);
    }

    .easy-btn.correct {
      background: rgba(52, 211, 153, .2);
      border-color: var(--green);
      color: var(--green);
    }

    .easy-btn.wrong {
      background: rgba(248, 113, 113, .2);
      border-color: var(--red);
      color: var(--red);
    }

    .easy-btn:disabled {
      opacity: 0.8;
      cursor: not-allowed;
    }

    /* Feedback container under input */
    .feedback {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      margin-top: 12px;
      min-height: 50px;
      pointer-events: none;
      background: transparent;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .feedback.active {
      opacity: 1;
    }

    .feedback-bubble {
      padding: 18px 32px;
      border-radius: 20px;
      font-size: 1.4rem;
      font-weight: 700;
      opacity: 0;
      transform: scale(.85);
      transition: opacity .18s, transform .18s;
    }

    .feedback-bubble.show {
      opacity: 1;
      transform: scale(1);
    }

    .feedback-bubble.ok {
      background: rgba(52, 211, 153, .2);
      color: var(--green);
      border: 1px solid var(--green);
    }

    .feedback-bubble.bad {
      background: rgba(248, 113, 113, .2);
      color: var(--red);
      border: 1px solid var(--red);
    }

    /* ‚îÄ‚îÄ Summary screen ‚îÄ‚îÄ */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat-box {
      background: var(--surface2);
      border-radius: 10px;
      padding: 12px 14px;
      text-align: center;
    }

    .stat-box .val {
      font-size: 1.8rem;
      font-weight: 700;
      line-height: 1;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-box .lbl {
      font-size: .72rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .stat-box.full {
      grid-column: 1 / -1;
    }

    .mistakes-title {
      font-size: .9rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .mistakes-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .82rem;
    }

    .mistakes-table th {
      text-align: left;
      color: var(--muted);
      font-weight: 500;
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
    }

    .mistakes-table td {
      padding: 7px 8px;
      border-bottom: 1px solid var(--border);
      font-family: 'Noto Sans JP', sans-serif;
    }

    .mistakes-table td.roma {
      font-family: 'Inter', sans-serif;
      color: var(--accent2);
    }

    .mistakes-table td.errs {
      font-family: 'Inter', sans-serif;
      color: var(--red);
      font-weight: 600;
      text-align: right;
    }

    .memo-bar {
      height: 8px;
      background: var(--surface2);
      border-radius: 99px;
      overflow: hidden;
      margin-top: 8px;
    }

    .memo-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--green));
      border-radius: 99px;
      transition: width .6s ease;
    }

    .memo-label {
      font-size: .78rem;
      color: var(--muted);
      margin-top: 6px;
    }

    .memo-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    .memo-tag {
      background: var(--surface2);
      border: 1px solid var(--accent);
      color: var(--text);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: 'Noto Sans JP', sans-serif;
    }

    .summary-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* ‚îÄ‚îÄ Misc ‚îÄ‚îÄ */
    .divider {
      height: 1px;
      background: var(--border);
    }

    a {
      color: var(--accent2);
      text-decoration: none;
    }

    .footer {
      margin-top: auto;
      padding-top: 30px;
      text-align: center;
      font-size: 0.7rem;
      color: var(--muted);
      opacity: 0.6;
    }

    @media (prefers-color-scheme: light) {
      /* stays dark ‚Äî intentional */
    }
  </style>
</head>

<body>
  <div id="app">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SELECTION SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="screen-select" class="screen active">
      <header>
        <h1>„Åã„Å™ Quiz</h1>
        <p>Select the kana you want to practice</p>
      </header>

      <div class="mode-toggle">
        <button id="mode-normal" class="active" style="font-size: 0.70rem;">Type<br>(K‚ÜíR)</button>
        <button id="mode-easy" style="font-size: 0.70rem;">Select<br>(K‚ÜíR)</button>
        <button id="mode-easy-kk" style="font-size: 0.70rem;">Select<br>(K‚ÜíK)</button>
        <button id="mode-audio-select" style="font-size: 0.70rem;">Select<br>(üîä‚ÜíK)</button>
        <button id="mode-simple" style="font-size: 0.70rem;">Select<br>(R‚ÜíK)</button>
        <button id="mode-draw" style="font-size: 0.70rem;">Draw<br>(R‚ÜíK)</button>
        <button id="mode-draw-kk" style="font-size: 0.70rem;">Draw<br>(K‚ÜíK)</button>
        <button id="mode-audio-draw" style="font-size: 0.70rem;">Draw<br>(üîä‚ÜíK)</button>
      </div>

      <div class="sel-controls">
        <button class="btn btn-outline" id="btn-all">Select All</button>
        <button class="btn btn-outline" id="btn-none">Deselect All</button>
      </div>

      <div id="group-list"><!-- rendered by JS --></div>

      <p class="sel-count" id="sel-count">0 entries selected</p>
      <button class="btn btn-primary" id="btn-start" disabled>Start Quiz</button>

      <footer class="footer">
        <p>&copy; 2026 Dave Wang | Version: 20260222-2114</p>
      </footer>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QUIZ SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="screen-quiz" class="screen">
      <header>
        <h1>„Åã„Å™ Quiz</h1>
      </header>

      <div class="quiz-meta">
        <span id="q-progress">Q 1</span>
        <span class="quiz-score" id="q-score">‚úì 0 &nbsp; ‚úó 0</span>
        <button class="btn btn-ghost" id="btn-end">End</button>
      </div>

      <div class="card kana-display">
        <span class="script-badge" id="script-label">Hiragana</span>
        <div id="audio-btn-container"
          style="display: none; align-items: center; justify-content: center; margin-bottom: 10px; margin-top: -10px;">
          <button class="btn btn-primary" id="btn-replay-audio"
            style="border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; display: flex; align-items: center; justify-content: center;">üîä</button>
        </div>
        <span class="kana-char" id="kana-char">„ÅÇ</span>
      </div>

      <div class="input-row" id="input-row">
        <input id="romaji-input" type="text" autocomplete="off" autocorrect="off" autocapitalize="none"
          spellcheck="false" placeholder="romaji‚Ä¶" />
        <button class="btn btn-primary" id="submit-btn">‚Üí</button>
      </div>

      <div class="easy-grid" id="easy-grid" style="display:none;"></div>

      <div class="draw-area" id="draw-area" style="display:none;">
        <canvas id="draw-canvas" width="280" height="280"></canvas>
        <div class="draw-controls" id="draw-submit-area">
          <button class="btn btn-outline" id="btn-draw-clear">Clear</button>
          <button class="btn btn-primary" id="btn-draw-show">Show Answer</button>
        </div>
        <div class="self-grade" id="self-grade" style="display:none;">
          <button class="btn btn-wrong" id="btn-self-wrong">Incorrect</button>
          <button class="btn btn-correct" id="btn-self-correct">Correct</button>
        </div>
      </div>

      <div class="feedback" id="feedback">
        <div class="feedback-bubble" id="feedback-bubble"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUMMARY SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div id="screen-summary" class="screen">
      <header>
        <h1>Session Summary</h1>
        <p id="sum-date"></p>
      </header>

      <div class="stats-grid" id="stats-grid"><!-- filled by JS --></div>

      <div class="card">
        <div class="memo-label" id="memo-label">Memorized 0 / 0 entries</div>
        <div class="memo-bar">
          <div class="memo-bar-fill" id="memo-fill" style="width:0%"></div>
        </div>
        <div class="memo-label" style="margin-top:8px;font-size:.72rem">
          Rule: ‚â• 3 shown &amp; all correct for both hiragana and katakana
        </div>
        <div id="memo-results" style="display:none; margin-top: 15px;">
          <p class="mistakes-title">Newly Memorized Characters</p>
          <div class="memo-list" id="memo-list"></div>
        </div>
      </div>

      <div id="mistakes-section" style="display:none;">
        <div class="card">
          <p class="mistakes-title">Characters you got wrong</p>
          <table class="mistakes-table">
            <thead>
              <tr>
                <th>Hiragana</th>
                <th>Katakana</th>
                <th>Romaji</th>
                <th>Script</th>
                <th style="text-align:right">Errors</th>
              </tr>
            </thead>
            <tbody id="mistakes-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="summary-actions">
        <button class="btn btn-primary" id="btn-retry">Practice Again</button>
        <button class="btn btn-outline" id="btn-reselect">Change Selection</button>
      </div>
    </div>

  </div>

  <!-- Feedback overlay moved inside kana-display -->

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  KANA DATA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const KANA_GROUPS = [
      {
        name: "Vowels", entries: [
          { h: "„ÅÇ", k: "„Ç¢", r: "a" }, { h: "„ÅÑ", k: "„Ç§", r: "i" },
          { h: "„ÅÜ", k: "„Ç¶", r: "u" }, { h: "„Åà", k: "„Ç®", r: "e" },
          { h: "„Åä", k: "„Ç™", r: "o" },
        ]
      },
      {
        name: "K row", entries: [
          { h: "„Åã", k: "„Ç´", r: "ka" }, { h: "„Åç", k: "„Ç≠", r: "ki" },
          { h: "„Åè", k: "„ÇØ", r: "ku" }, { h: "„Åë", k: "„Ç±", r: "ke" },
          { h: "„Åì", k: "„Ç≥", r: "ko" },
        ]
      },
      {
        name: "S row", entries: [
          { h: "„Åï", k: "„Çµ", r: "sa" }, { h: "„Åó", k: "„Ç∑", r: "shi" },
          { h: "„Åô", k: "„Çπ", r: "su" }, { h: "„Åõ", k: "„Çª", r: "se" },
          { h: "„Åù", k: "„ÇΩ", r: "so" },
        ]
      },
      {
        name: "T row", entries: [
          { h: "„Åü", k: "„Çø", r: "ta" }, { h: "„Å°", k: "„ÉÅ", r: "chi" },
          { h: "„Å§", k: "„ÉÑ", r: "tsu" }, { h: "„Å¶", k: "„ÉÜ", r: "te" },
          { h: "„Å®", k: "„Éà", r: "to" },
        ]
      },
      {
        name: "N row", entries: [
          { h: "„Å™", k: "„Éä", r: "na" }, { h: "„Å´", k: "„Éã", r: "ni" },
          { h: "„Å¨", k: "„Éå", r: "nu" }, { h: "„Å≠", k: "„Éç", r: "ne" },
          { h: "„ÅÆ", k: "„Éé", r: "no" },
        ]
      },
      {
        name: "H row", entries: [
          { h: "„ÅØ", k: "„Éè", r: "ha" }, { h: "„Å≤", k: "„Éí", r: "hi" },
          { h: "„Åµ", k: "„Éï", r: "fu" }, { h: "„Å∏", k: "„Éò", r: "he" },
          { h: "„Åª", k: "„Éõ", r: "ho" },
        ]
      },
      {
        name: "M row", entries: [
          { h: "„Åæ", k: "„Éû", r: "ma" }, { h: "„Åø", k: "„Éü", r: "mi" },
          { h: "„ÇÄ", k: "„É†", r: "mu" }, { h: "„ÇÅ", k: "„É°", r: "me" },
          { h: "„ÇÇ", k: "„É¢", r: "mo" },
        ]
      },
      {
        name: "Y row", entries: [
          { h: "„ÇÑ", k: "„É§", r: "ya" }, { h: "„ÇÜ", k: "„É¶", r: "yu" },
          { h: "„Çà", k: "„É®", r: "yo" },
        ]
      },
      {
        name: "R row", entries: [
          { h: "„Çâ", k: "„É©", r: "ra" }, { h: "„Çä", k: "„É™", r: "ri" },
          { h: "„Çã", k: "„É´", r: "ru" }, { h: "„Çå", k: "„É¨", r: "re" },
          { h: "„Çç", k: "„É≠", r: "ro" },
        ]
      },
      {
        name: "W row / N", entries: [
          { h: "„Çè", k: "„ÉØ", r: "wa" }, { h: "„Çí", k: "„É≤", r: "wo" },
          { h: "„Çì", k: "„É≥", r: "n" },
        ]
      },
      {
        name: "G row (voiced)", entries: [
          { h: "„Åå", k: "„Ç¨", r: "ga" }, { h: "„Åé", k: "„ÇÆ", r: "gi" },
          { h: "„Åê", k: "„Ç∞", r: "gu" }, { h: "„Åí", k: "„Ç≤", r: "ge" },
          { h: "„Åî", k: "„Ç¥", r: "go" },
        ]
      },
      {
        name: "Z row (voiced)", entries: [
          { h: "„Åñ", k: "„Ç∂", r: "za" }, { h: "„Åò", k: "„Ç∏", r: "ji" },
          { h: "„Åö", k: "„Ç∫", r: "zu" }, { h: "„Åú", k: "„Çº", r: "ze" },
          { h: "„Åû", k: "„Çæ", r: "zo" },
        ]
      },
      {
        name: "D row (voiced)", entries: [
          { h: "„Å†", k: "„ÉÄ", r: "da" }, { h: "„Å¢", k: "„ÉÇ", r: "ji" },
          { h: "„Å•", k: "„ÉÖ", r: "zu" }, { h: "„Åß", k: "„Éá", r: "de" },
          { h: "„Å©", k: "„Éâ", r: "do" },
        ]
      },
      {
        name: "B row (voiced)", entries: [
          { h: "„Å∞", k: "„Éê", r: "ba" }, { h: "„Å≥", k: "„Éì", r: "bi" },
          { h: "„Å∂", k: "„Éñ", r: "bu" }, { h: "„Åπ", k: "„Éô", r: "be" },
          { h: "„Åº", k: "„Éú", r: "bo" },
        ]
      },
      {
        name: "P row (semi-voiced)", entries: [
          { h: "„Å±", k: "„Éë", r: "pa" }, { h: "„Å¥", k: "„Éî", r: "pi" },
          { h: "„Å∑", k: "„Éó", r: "pu" }, { h: "„Å∫", k: "„Éö", r: "pe" },
          { h: "„ÅΩ", k: "„Éù", r: "po" },
        ]
      },
    ];

    const MEMORIZE_THRESHOLD = 3;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentMode = 'normal'; // 'normal', 'easy', 'simple', 'draw'
    let selectedEntries = [];   // entries chosen on selection screen
    let stats = {};             // romaji -> { h: {shown,correct}, k: {shown,correct} }
    let sessionTotal = 0;
    let sessionCorrect = 0;
    let seenChars = new Set();
    let mistakes = {};    // key -> { entry, script, count }
    let startTime = null;
    let currentEntry = null;
    let currentScript = null;  // 'h' or 'k'

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  DRAWING LOGIC
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const canvas = document.getElementById('draw-canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    function clearCanvas() {
      ctx.fillStyle = '#1e2330';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    clearCanvas();

    function startDraw(e) {
      isDrawing = true;
      const pos = getMousePos(e);
      lastX = pos.x;
      lastY = pos.y;
    }

    function draw(e) {
      if (!isDrawing) return;
      e.preventDefault();
      const pos = getMousePos(e);

      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(pos.x, pos.y);
      ctx.strokeStyle = '#e8eaf0';
      ctx.lineWidth = 6;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.stroke();

      lastX = pos.x;
      lastY = pos.y;
    }

    function stopDraw() {
      isDrawing = false;
      ctx.beginPath();
    }

    function getMousePos(evt) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      if (evt.touches && evt.touches.length > 0) {
        return {
          x: (evt.touches[0].clientX - rect.left) * scaleX,
          y: (evt.touches[0].clientY - rect.top) * scaleY
        };
      }
      return {
        x: (evt.clientX - rect.left) * scaleX,
        y: (evt.clientY - rect.top) * scaleY
      };
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseout', stopDraw);

    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDraw, { passive: false });
    canvas.addEventListener('touchcancel', stopDraw, { passive: false });

    document.getElementById('btn-draw-clear').addEventListener('click', clearCanvas);
    document.getElementById('btn-draw-show').addEventListener('click', () => {
      // Reveal answer in kana-char
      const charEl = document.getElementById('kana-char');

      let ans = '';
      if (currentMode === 'draw-kk') {
        ans = currentScript === 'h' ? currentEntry.k : currentEntry.h;
      } else {
        ans = currentScript === 'h' ? currentEntry.h : currentEntry.k;
      }

      charEl.style.fontFamily = "'Noto Sans JP', sans-serif";
      charEl.style.color = "";
      charEl.innerHTML = `<span>${ans}</span>`;

      document.getElementById('draw-submit-area').style.display = 'none';
      document.getElementById('self-grade').style.display = 'flex';
    });

    document.getElementById('btn-self-correct').addEventListener('click', () => submitAnswer(null, null, true));
    document.getElementById('btn-self-wrong').addEventListener('click', () => submitAnswer(null, null, false));

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUDIO LOGIC
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let jpVoice = null;

    function initSpeechSynthesis() {
      const loadVoices = () => {
        const voices = speechSynthesis.getVoices();
        jpVoice = voices.find(v => v.lang === 'ja-JP' || v.lang.startsWith('ja')) || voices[0];
      };

      speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();
    }
    initSpeechSynthesis();

    function playAudioChar(char) {
      if (!('speechSynthesis' in window)) return;
      const utterance = new SpeechSynthesisUtterance(char);
      utterance.lang = 'ja-JP';
      if (jpVoice) {
        utterance.voice = jpVoice;
      }
      utterance.rate = 0.85; // Slightly slower for clarity
      speechSynthesis.speak(utterance);
    }

    document.getElementById('btn-replay-audio').addEventListener('click', () => {
      const scriptChar = currentScript === 'h' ? currentEntry.h : currentEntry.k;
      playAudioChar(scriptChar);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SELECTION SCREEN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function buildSelectionScreen() {
      const list = document.getElementById('group-list');
      list.innerHTML = '';

      KANA_GROUPS.forEach((group, gi) => {
        const block = document.createElement('div');
        block.className = 'group-block';

        // group header with master checkbox
        const hdr = document.createElement('div');
        hdr.className = 'group-header';

        const masterCb = document.createElement('input');
        masterCb.type = 'checkbox';
        masterCb.id = `grp-cb-${gi}`;
        masterCb.checked = true;

        const lbl = document.createElement('label');
        lbl.htmlFor = masterCb.id;
        lbl.textContent = group.name;

        const cnt = document.createElement('span');
        cnt.id = `grp-cnt-${gi}`;

        hdr.appendChild(masterCb);
        hdr.appendChild(lbl);
        hdr.appendChild(cnt);
        block.appendChild(hdr);

        // entries grid
        const grid = document.createElement('div');
        grid.className = 'group-entries';

        group.entries.forEach((entry, ei) => {
          const row = document.createElement('label');
          row.className = 'kana-entry';

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.dataset.gi = gi;
          cb.dataset.ei = ei;
          cb.checked = true;
          cb.addEventListener('change', () => updateGroupState(gi));

          const chars = document.createElement('div');
          chars.className = 'kana-chars';
          chars.innerHTML = `<span class="hira">${entry.h}</span><span class="kata">${entry.k}</span>`;

          const roma = document.createElement('span');
          roma.className = 'kana-roma';
          roma.textContent = entry.r;

          row.appendChild(cb);
          row.appendChild(chars);
          row.appendChild(roma);
          grid.appendChild(row);
        });

        block.appendChild(grid);
        list.appendChild(block);

        // master checkbox toggles all in group
        masterCb.addEventListener('change', () => {
          getGroupCheckboxes(gi).forEach(cb => cb.checked = masterCb.checked);
          updateGroupState(gi);
        });

        updateGroupState(gi);
      });

      updateSelCount();
    }

    function getGroupCheckboxes(gi) {
      return Array.from(document.querySelectorAll(`input[data-gi="${gi}"]`));
    }

    function updateGroupState(gi) {
      const cbs = getGroupCheckboxes(gi);
      const total = cbs.length;
      const checked = cbs.filter(c => c.checked).length;
      const masterCb = document.getElementById(`grp-cb-${gi}`);
      const cnt = document.getElementById(`grp-cnt-${gi}`);

      masterCb.checked = checked === total;
      masterCb.indeterminate = checked > 0 && checked < total;
      cnt.textContent = `${checked}/${total}`;
      updateSelCount();
    }

    function getAllEntryCheckboxes() {
      return Array.from(document.querySelectorAll('.kana-entry input[type=checkbox]'));
    }

    function updateSelCount() {
      const checked = getAllEntryCheckboxes().filter(c => c.checked).length;
      document.getElementById('sel-count').innerHTML =
        `<strong>${checked}</strong> entr${checked === 1 ? 'y' : 'ies'} selected`;
      document.getElementById('btn-start').disabled = checked === 0;
    }

    document.getElementById('btn-all').addEventListener('click', () => {
      getAllEntryCheckboxes().forEach(cb => cb.checked = true);
      KANA_GROUPS.forEach((_, gi) => updateGroupState(gi));
    });

    document.getElementById('btn-none').addEventListener('click', () => {
      getAllEntryCheckboxes().forEach(cb => cb.checked = false);
      KANA_GROUPS.forEach((_, gi) => updateGroupState(gi));
    });

    [
      { id: 'mode-normal', val: 'normal' },
      { id: 'mode-easy', val: 'easy' },
      { id: 'mode-easy-kk', val: 'easy-kk' },
      { id: 'mode-audio-select', val: 'audio-select' },
      { id: 'mode-simple', val: 'simple' },
      { id: 'mode-draw', val: 'draw' },
      { id: 'mode-draw-kk', val: 'draw-kk' },
      { id: 'mode-audio-draw', val: 'audio-draw' }
    ].forEach(m => {
      document.getElementById(m.id).addEventListener('click', (e) => {
        currentMode = m.val;
        document.querySelectorAll('.mode-toggle button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
      });
    });

    document.getElementById('btn-start').addEventListener('click', startQuiz);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  QUIZ
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function startQuiz() {
      // collect selected entries
      selectedEntries = [];
      getAllEntryCheckboxes().forEach(cb => {
        if (cb.checked) {
          const g = KANA_GROUPS[cb.dataset.gi];
          selectedEntries.push(g.entries[cb.dataset.ei]);
        }
      });

      // init stats
      stats = {};
      selectedEntries.forEach(e => {
        stats[e.r] = stats[e.r] || { h: { shown: 0, correct: 0 }, k: { shown: 0, correct: 0 } };
      });

      sessionTotal = 0;
      sessionCorrect = 0;
      seenChars = new Set();
      mistakes = {};
      startTime = Date.now();

      showScreen('quiz');
      nextQuestion();
      document.getElementById('romaji-input').focus();
    }

    function nextQuestion() {
      currentEntry = selectedEntries[Math.floor(Math.random() * selectedEntries.length)];
      currentScript = Math.random() < 0.5 ? 'h' : 'k';

      const isSimpleLike = currentMode === 'simple' || currentMode === 'draw';
      const isKKLike = currentMode === 'easy-kk' || currentMode === 'draw-kk';
      const isAudioLike = currentMode === 'audio-select' || currentMode === 'audio-draw';

      const char = isSimpleLike ? currentEntry.r : (currentScript === 'h' ? currentEntry.h : currentEntry.k);

      // Still consider the target script as seen for stats, even if showing romaji/playing audio
      const scriptChar = currentScript === 'h' ? currentEntry.h : currentEntry.k;
      seenChars.add(scriptChar);

      let headerLabel = currentScript === 'h' ? 'Hiragana' : 'Katakana';
      if (isSimpleLike) {
        headerLabel = 'Romaji ‚Üí ' + (currentScript === 'h' ? 'Hiragana' : 'Katakana');
      } else if (isKKLike) {
        headerLabel = (currentScript === 'h' ? 'Hiragana' : 'Katakana') + ' ‚Üí ' + (currentScript === 'h' ? 'Katakana' : 'Hiragana');
      } else if (isAudioLike) {
        headerLabel = 'Audio ‚Üí ' + (currentScript === 'h' ? 'Hiragana' : 'Katakana');
      }
      document.getElementById('script-label').textContent = headerLabel;

      // Update font styling for the display character
      const charEl = document.getElementById('kana-char');
      const audioBtnDiv = document.getElementById('audio-btn-container');

      charEl.style.fontFamily = isSimpleLike ? "'Inter', sans-serif" : "'Noto Sans JP', sans-serif";
      charEl.style.color = isSimpleLike ? "var(--accent2)" : "";

      audioBtnDiv.style.display = 'none';

      if (isAudioLike) {
        charEl.innerHTML = `<div style="font-size: 0.3em; color: var(--muted); margin-top: 10px;">Listen carefully!</div>`;
        audioBtnDiv.style.display = 'flex';
        playAudioChar(scriptChar);
      } else if (currentMode === 'draw' || currentMode === 'draw-kk') {
        charEl.innerHTML = `<span>${char}</span><div style="font-size: 0.2em; color: var(--muted); margin-top: 10px;">Draw above</div>`;
      } else {
        charEl.textContent = char;
      }

      document.getElementById('q-progress').textContent = `Q ${sessionTotal + 1}`;

      const inpRow = document.getElementById('input-row');
      const grid = document.getElementById('easy-grid');
      const drawArea = document.getElementById('draw-area');

      // Reset draw block elements
      drawArea.style.display = 'none';
      grid.style.display = 'none';
      inpRow.style.display = 'none';

      if (currentMode === 'easy' || currentMode === 'simple' || currentMode === 'easy-kk' || currentMode === 'audio-select') {
        inpRow.style.display = 'none';
        grid.style.display = 'grid';
        grid.innerHTML = '';

        // determine options pool precisely from user selection
        let poolItems = [];
        let targetAns = '';

        if (currentMode === 'simple' || currentMode === 'audio-select') {
          poolItems = selectedEntries.map(e => currentScript === 'h' ? e.h : e.k);
          targetAns = currentScript === 'h' ? currentEntry.h : currentEntry.k;
        } else if (currentMode === 'easy-kk') {
          poolItems = selectedEntries.map(e => currentScript === 'h' ? e.k : e.h);
          targetAns = currentScript === 'h' ? currentEntry.k : currentEntry.h;
        } else {
          // 'easy' mode
          poolItems = selectedEntries.map(e => e.r);
          targetAns = currentEntry.r;
        }

        let pool = [...new Set(poolItems)];
        let optionsCount = Math.min(10, pool.length);

        let options = [targetAns];

        while (options.length < optionsCount) {
          let cand = pool[Math.floor(Math.random() * pool.length)];
          if (!options.includes(cand)) options.push(cand);
        }
        options.sort(() => Math.random() - 0.5); // shuffle

        options.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = (currentMode === 'simple' || currentMode === 'easy-kk' || currentMode === 'audio-select') ? 'easy-btn simple-btn' : 'easy-btn';
          btn.textContent = opt;
          btn.onclick = () => submitAnswer(opt, btn);
          grid.appendChild(btn);
        });
      } else if (currentMode === 'draw' || currentMode === 'draw-kk' || currentMode === 'audio-draw') {
        drawArea.style.display = 'flex';
        document.getElementById('draw-submit-area').style.display = 'flex';
        document.getElementById('self-grade').style.display = 'none';
        clearCanvas();
      } else {
        inpRow.style.display = 'flex';
        grid.style.display = 'none';
        const inp = document.getElementById('romaji-input');
        inp.value = '';
        inp.className = '';
        inp.focus();
      }
    }

    function submitAnswer(optAnswer = null, btnEl = null, selfGradedCorrect = null) {
      const inp = document.getElementById('romaji-input');
      const answer = (optAnswer || inp.value).trim().toLowerCase();
      // Only block empty answers for normal text mode
      if (!answer && currentMode === 'normal') return;

      const isSimpleLike = currentMode === 'simple' || currentMode === 'draw';
      const isKKLike = currentMode === 'easy-kk' || currentMode === 'draw-kk';
      const isAudioLike = currentMode === 'audio-select' || currentMode === 'audio-draw';

      let expected = currentEntry.r;
      if (isSimpleLike || isAudioLike) {
        expected = currentScript === 'h' ? currentEntry.h : currentEntry.k;
      } else if (isKKLike) {
        expected = currentScript === 'h' ? currentEntry.k : currentEntry.h;
      }
      const key = currentScript === 'h' ? 'h' : 'k';
      const formStat = stats[currentEntry.r][key];

      sessionTotal++;
      formStat.shown++;

      let correct = false;
      if (currentMode === 'draw' || currentMode === 'draw-kk' || currentMode === 'audio-draw') {
        correct = selfGradedCorrect;
      } else {
        correct = answer === expected;
      }

      if (currentMode === 'easy' || currentMode === 'simple' || currentMode === 'easy-kk' || currentMode === 'audio-select') {
        document.querySelectorAll('.easy-btn').forEach(b => b.disabled = true);
        if (correct) {
          btnEl.classList.add('correct');
        } else {
          btnEl.classList.add('wrong');
          document.querySelectorAll('.easy-btn').forEach(b => {
            if (b.textContent === expected) b.classList.add('correct');
          });
        }
      } else if (currentMode === 'normal') {
        if (correct) inp.classList.add('correct');
        else inp.classList.add('wrong');
      }

      if (correct) {
        sessionCorrect++;
        formStat.correct++;
        if (currentMode === 'draw' || currentMode === 'draw-kk' || currentMode === 'audio-draw') setTimeout(() => nextQuestion(), 100);
        else showFeedback(true, expected);
      } else {
        if (currentMode === 'draw' || currentMode === 'draw-kk' || currentMode === 'audio-draw') setTimeout(() => nextQuestion(), 100);
        else showFeedback(false, expected);

        const mk = `${currentEntry.h}|${expected}`;
        if (!mistakes[mk]) {
          mistakes[mk] = { entry: currentEntry, script: currentScript === 'h' ? 'Hiragana' : 'Katakana', count: 0 };
        }
        mistakes[mk].count++;
      }

      updateQuizMeta();
    }

    function updateQuizMeta() {
      const wrong = sessionTotal - sessionCorrect;
      document.getElementById('q-score').innerHTML =
        `‚úì ${sessionCorrect} &nbsp; ‚úó ${wrong}`;
    }

    function showFeedback(ok, expected) {
      const overlay = document.getElementById('feedback');
      const bubble = document.getElementById('feedback-bubble');
      bubble.textContent = ok ? '‚úì Correct!' : `‚úó  ${expected}`;
      bubble.className = `feedback-bubble ${ok ? 'ok' : 'bad'}`;

      const duration = ok ? 800 : 2500; // Longer for errors

      overlay.classList.add('active');
      requestAnimationFrame(() => {
        bubble.classList.add('show');
        setTimeout(() => {
          bubble.classList.remove('show');
          overlay.classList.remove('active');
          setTimeout(() => nextQuestion(), 180);
        }, duration);
      });
    }

    document.getElementById('submit-btn').addEventListener('click', () => submitAnswer());
    document.getElementById('romaji-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') submitAnswer();
    });
    const romajiInput = document.getElementById('romaji-input');
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    if (isIOS) {
      romajiInput.addEventListener('focus', () => {
        setTimeout(() => window.scrollTo(0, 0), 50);
        setTimeout(() => window.scrollTo(0, 0), 300);
      });
      window.addEventListener('scroll', () => {
        if (document.activeElement === romajiInput) {
          window.scrollTo(0, 0);
          document.body.scrollTop = 0;
        }
      });
    } else {
      romajiInput.addEventListener('focus', () => {
        setTimeout(() => window.scrollTo(0, 0), 100);
      });
    }
    document.getElementById('btn-end').addEventListener('click', endSession);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SUMMARY
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function isFormMemorized(f) {
      return f.shown >= MEMORIZE_THRESHOLD && f.correct === f.shown;
    }
    function isEntryMemorized(e) {
      const s = stats[e.r];
      return s && isFormMemorized(s.h) && isFormMemorized(s.k);
    }

    function endSession() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      const wrong = sessionTotal - sessionCorrect;
      const score = sessionTotal ? (sessionCorrect / sessionTotal * 100).toFixed(1) : '‚Äî';
      const now = new Date();

      // stats grid
      const grid = document.getElementById('stats-grid');
      const statsData = [
        { val: sessionTotal, lbl: 'Questions' },
        { val: sessionCorrect, lbl: 'Correct' },
        { val: wrong, lbl: 'Incorrect' },
        { val: seenChars.size, lbl: 'Distinct Chars' },
        { val: `${mins}m ${String(secs).padStart(2, '0')}s`, lbl: 'Duration', full: false },
        { val: `${score}%`, lbl: 'Score', full: false },
      ];
      grid.innerHTML = statsData.map(s =>
        `<div class="stat-box${s.full ? ' full' : ''}">
       <div class="val">${s.val}</div>
       <div class="lbl">${s.lbl}</div>
     </div>`
      ).join('');

      // memorization bar
      const newlyMemorized = selectedEntries.filter(isEntryMemorized);
      const memorizedCount = newlyMemorized.length;
      const pct = selectedEntries.length ? (memorizedCount / selectedEntries.length * 100) : 0;
      document.getElementById('memo-fill').style.width = pct + '%';
      document.getElementById('memo-label').textContent =
        `Memorized ${memorizedCount} / ${selectedEntries.length} entries`;

      const memoResults = document.getElementById('memo-results');
      const memoList = document.getElementById('memo-list');
      if (newlyMemorized.length > 0) {
        memoResults.style.display = 'block';
        memoList.innerHTML = newlyMemorized.map(e =>
          `<div class="memo-tag">${e.h} / ${e.k} (${e.r})</div>`
        ).join('');
      } else {
        memoResults.style.display = 'none';
      }

      // mistakes table
      const mkList = Object.values(mistakes).sort((a, b) => b.count - a.count);
      if (mkList.length) {
        document.getElementById('mistakes-section').style.display = 'block';
        document.getElementById('mistakes-tbody').innerHTML = mkList.map(m =>
          `<tr>
        <td>${m.entry.h}</td>
        <td>${m.entry.k}</td>
        <td class="roma">${m.entry.r}</td>
        <td class="roma">${m.script}</td>
        <td class="errs">${m.count}</td>
       </tr>`
        ).join('');
      } else {
        document.getElementById('mistakes-section').style.display = 'none';
      }

      document.getElementById('sum-date').textContent =
        now.toLocaleString();

      showScreen('summary');
    }



    document.getElementById('btn-retry').addEventListener('click', () => {
      startQuiz();
    });
    document.getElementById('btn-reselect').addEventListener('click', () => {
      showScreen('select');
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SCREEN ROUTER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showScreen(name) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const activeScreen = document.getElementById(`screen-${name}`);
      activeScreen.classList.add('active');

      const app = document.getElementById('app');

      window.scrollTo(0, 0);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    buildSelectionScreen();

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registered!', reg))
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>

</html>